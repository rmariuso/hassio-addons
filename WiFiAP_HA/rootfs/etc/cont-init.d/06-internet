#!/usr/bin/with-contenv bashio
# ==============================================================================
# Home Assistant Community Add-on: Pi-hole
# Runs the hostapd 
# ==============================================================================

# Get the Default Route interface
#DEFAULT_ROUTE_INTERFACE=$(ip route show default | awk '/^default/ { print $5 }')
# Declare variables

declare client_internet_access
client_internet_access=$(bashio::config 'client_internet_access')

## Route traffic
#iptables-nft -t nat -A POSTROUTING -o end0 -j MASQUERADE
#iptables-nft -P FORWARD ACCEPT
#iptables-nft -F FORWARD

if $(bashio::config.true "client_internet_access"); then
    bashio::log.info "internet acces"
    iptables -I DOCKER-USER -i src_if -o dst_if -j ACCEPT
    iptables -t nat -C POSTROUTING -o end0 -j MASQUERADE || iptables -t nat -A POSTROUTING -o end0 -j MASQUERADE
    iptables -C FORWARD -i end0 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT || iptables -A FORWARD -i end0 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT
    iptables -C FORWARD -i wlan0 -o end0 -j ACCEPT || iptables -A FORWARD -i wlan0 -o end0 -j ACCEPT
#    iptables-save
fi