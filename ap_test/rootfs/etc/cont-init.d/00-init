#!/usr/bin/with-contenv bashio

if ! bashio::fs.directory_exists /config/wifiap; then
    mkdir -p /config/wifiap/
    mkdir -p /config/wifiap/backups
    mkdir -p /config/wifiap/networking
    mkdir -p /config/wifiap/hostapd
    mkdir -p /config/wifiap/dhcpcd
    mkdir -p /config/wifiap/dnsmasq
    mkdir -p /config/wifiap/lighttpd
    mkdir -p /config/wifiap/system

    mv /var/www/html/installers/enablelog.sh /config/wifiap/hostapd
    mv /var/www/html/installers/disablelog.sh /config/wifiap/hostapd
    cp /home/servicestart.sh /config/wifiap/hostapd
    mv /var/www/html/installers/debuglog.sh /config/wifiap/system
    cp /home/configport.sh /config/wifiap/lighttpd
    mv /etc/default/hostapd ~/default_hostapd.old
    cp /var/www/html/config/hostapd.conf /config/wifiap/hostapd/hostapd.conf
    cp /var/www/html/config/dhcpcd.conf /config/wifiap/dhcpcd/dhcpcd.conf
    cp /home/090_raspap.conf /config/wifiap/dnsmasq/090_raspap.conf
    cp /home/090_wlan0.conf /config/wifiap/dnsmasq/090_wlan0.conf
    cp /home/config.php /var/www/html/includes/
    cp /var/www/html/config/defaults.json /config/wifiap/networking/
fi

chown -R www-data:www-data /var/www/html
chown -R www-data:www-data /config/wifiap
chown -c root:root /config/wifiap/hostapd/*.sh
chmod 750 /config/wifiap/hostapd/*.sh
chown -c root:root /config/wifiap/system/*.sh
chmod 750 /config/wifiap/system/*.sh
chown -c root:root /config/wifiap/lighttpd/*.sh
cp /var/www/html/config/raspap-bridge-br0.netdev /etc/systemd/network/raspap-bridge-br0.netdev
cp /var/www/html/config/raspap-br0-member-eth0.network /etc/systemd/network/raspap-br0-member-eth0.network

DEFAULT_ROUTE_INTERFACE=$(ip route show default | awk '/^default/ { print $5 }')

echo "Hello world!"
#python3 -m http.server 8000

#Start dhcpcd
dhcpcd -f "/config/wifiap/dhcpcd/dhcpcd.conf"
sleep 3

#Start dnsmasq
dnsmasq -C "/config/wifiap/dnsmasq/090_raspap.conf"

#iptables-nft -t nat -A POSTROUTING -o $DEFAULT_ROUTE_INTERFACE -j MASQUERADE
iptables-nft -t nat -A POSTROUTING -o end0 -j MASQUERADE
iptables-nft -P FORWARD ACCEPT
iptables-nft -F FORWARD

#Start lighttpd
lighttpd-enable-mod fastcgi-php
WEBROOT="/var/www/html"
CONFSRC="$WEBROOT/config/50-raspap-router.conf"
LTROOT=$(grep "server.document-root" /etc/lighttpd/lighttpd.conf | awk -F '=' '{print $2}' | tr -d " \"")
HTROOT=${WEBROOT/$LTROOT}
HTROOT=$(echo "$HTROOT" | sed -e 's/\/$//')
awk "{gsub(\"/REPLACE_ME\",\"$HTROOT\")}1" $CONFSRC > /tmp/50-raspap-router.conf
cp /tmp/50-raspap-router.conf /etc/lighttpd/conf-available/
ln -s /etc/lighttpd/conf-available/50-raspap-router.conf /etc/lighttpd/conf-enabled/50-raspap-router.conf
sed -i -E 's/^session\.cookie_httponly\s*=\s*(0|([O|o]ff)|([F|f]alse)|([N|n]o))\s*$/session.cookie_httponly = 1/' /etc/php/8.2/cgi/php.ini
sed -i -E 's/^;?opcache\.enable\s*=\s*(0|([O|o]ff)|([F|f]alse)|([N|n]o))\s*$/opcache.enable = 1/' /etc/php/8.2/cgi/php.ini
phpenmod opcache
lighttpd -f /etc/lighttpd/lighttpd.conf

#Start hostapd
hostapd -d -B -i wlan0 /config/wifiap/hostapd/hostapd.conf -f /tmp/hostapd.log 1> /dev/null