#!/usr/bin/with-contenv bashio

bashio::log.info "Init..."
declare DIR
declare DIR_RASPAP
DIR="/config/wifiap"
DIR_RASPAP="${DIR}/raspap"
LANG="$(bashio::config 'language')"

# Ensure configuration exists
if ! bashio::fs.directory_exists "${DIR}"; then

	bashio::log.info "Create folders.."
    mkdir -p "${DIR_RASPAP}" || bashio::exit.nok "Failed to create hotspot_wifi configuration directory"
    mkdir -p "${DIR_RASPAP}/networking"
    mkdir -p "${DIR}/vnstat"
    mkdir -p "${DIR}/dhcpcd"
    mkdir -p "${DIR}/hostapd"
    mkdir -p "${DIR}/dnsmasq"

    #### dnsmasq
	bashio::log.info "MV de ${DIR}/dnsmasq/dnsmasq.conf"
	mv /var/www/html/config/090_raspap.conf "${DIR}/dnsmasq"
	mv /var/www/html/config/090_wlan0.conf "${DIR}/dnsmasq"
	grep -riIl "/etc/dnsmasq.d" "${DIR}/dnsmasq" | xargs sed -i "s|/etc/dnsmasq.d|${DIR}/dnsmasq|g"
	
	#### dhcpcd
	bashio::log.info "MV de ${DIR}/dhcpcd/dhcpcd.conf"
    mv /var/www/html/config/dhcpcd.conf "${DIR}/dhcpcd/dhcpcd.conf"

	#### hostapd
	bashio::log.info "MV de ${DIR}/hostapd/hostapd.conf"
    mv /var/www/html/config/hostapd.conf "${DIR}/hostapd/hostapd.conf"
	
	mv /var/www/html/config/defaults.json "${DIR_RASPAP}/networking/"
    mv /etc/vnstat.conf "${DIR_RASPAP}/vnstat.conf"

fi

mv /etc/config.php /var/www/html/includes/
#mv /var/www/html/app/icons/* /var/www/html

case $LANG in
    Deutsch) 
    sed -i -e 's/# de_DE.UTF-8 UTF-8/de_DE.UTF-8 UTF-8/' /etc/locale.gen
;;
    Español) 
    sed -i -e 's/# es_MX.UTF-8 UTF-8/es_MX.UTF-8 UTF-8/' /etc/locale.gen
;;
    Français) 
    sed -i -e 's/# fr_FR.UTF-8 UTF-8/fr_FR.UTF-8 UTF-8/' /etc/locale.gen
;;
    Italiano) 
    sed -i -e 's/# it_IT.UTF-8 UTF-8/it_IT.UTF-8 UTF-8/' /etc/locale.gen
;;
    Română) 
    sed -i -e 's/# ro_RO.UTF-8 UTF-8/ro_RO.UTF-8 UTF-8/' /etc/locale.gen
;;
    *) 
;;
esac
#locale-gen

#cp /var/www/html/installers/raspap.sudoers /etc/sudoers.d/090_raspap

sed -i -E 's/^session\.cookie_httponly\s*=\s*(0|([O|o]ff)|([F|f]alse)|([N|n]o))\s*$/session.cookie_httponly = 1/' /etc/php/8.2/cgi/php.ini
sed -i -E 's/^;?opcache\.enable\s*=\s*(0|([O|o]ff)|([F|f]alse)|([N|n]o))\s*$/opcache.enable = 1/' /etc/php/8.2/cgi/php.ini
phpenmod opcache

mkdir /run/lighttpd/
chown -R www-data:www-data /var/www/html
chown -R www-data:www-data "${DIR_RASPAP}"
chown -R www-data:www-data "${DIR}"
chown -R www-data:www-data "${DIR}/hostapd"

chown -R www-data:www-data /run/lighttpd
chown -R www-data:www-data /var/log/lighttpd/
chown -R www-data:www-data "${DIR}"  || bashio::exit.nok "Failed chown -R www-data:www-data ${DIR_RASPAP}"

echo '' > /tmp/hostapd.log
echo '' > /tmp/dnsmasq.log
chown -R www-data:www-data /tmp
chown -R www-data:www-data /var/tmp 

grep -riIl '/etc/raspap/hostapd.ini' /var/www/html/ | xargs sed -i "s|/etc/raspap/hostapd.ini|${DIR_RASPAP}/hostapd.ini|g"
grep -riIl "/etc/dnsmasq.d" /var/www/html/ | xargs sed -i "s|/etc/dnsmasq.d|${DIR}/dnsmasq|g"

echo '' >> "${DIR_RASPAP}/hostapd.ini"
	
grep -riIl 'sudo' /var/www/html/ | xargs sed -i "s|sudo||g"
grep -riIl 'hostname -f' /var/www/html/ | xargs sed -i "s|hostname -f|hostname|g"
#ifconfig wlan0 down
#ifconfig wlan0 up
